name: Build a simple deb package

env:
 CHANGELOG_AUTHOR_NAME: "Kaylor"
 CHANGELOG_AUTHOR_EMAIL: "kaylor.chen@qq.com"

on:
 push:
   branches:
   - master
jobs:
 build:
   runs-on: ubuntu-20.04
   steps:
   - name: Checkout Source Code
     uses: actions/checkout@v3
     with:
       fetch-depth: 0
       
   - name: Get latest tag
     id: latest-tag
     run: echo "::set-output name=tag::$(git describe --tags `git rev-list --tags --max-count=1`)"

   - name: Use the latest tag
     run: echo "The latest tag is ${{ steps.latest-tag.outputs.tag }}"

   - name: build package
     run: |
       ls -al
       set -xe
       git log
       git describe --tags --abbrev=0
       export VERSION=$(git describe --tags)
       export MSG=$(git log -n 1 --pretty=format:' %s')
       echo version is ${VERSION}, msg is ${MSG}
       docker run --rm -v ${PWD}:/root/simple-deb kaylor/ubuntu:simple_deb_env sh -c "export EMAIL=kaylor.chen@qq.com && cd /root/simple-deb && dch -v ${VERSION} ${MSG} && fakeroot debian/rules clean && fakeroot debian/rules binary && mv ../kaylordut*.deb ./"
       ls -al
       rm -rf ./artifact
       mkdir -p ./artifact
       cp kaylordut*arm64.deb ./artifact/kaylordut-dev_arm64.deb

   - name: Upload artifact
     uses: actions/upload-artifact@v3
     with:
       name: simple_deb
       path: ./artifact/

   - name: Publish packages
     uses: softprops/action-gh-release@v1
     with:
      files: |
        ./artifact/kaylordut-dev_arm64.deb
      # env:
      #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

